<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß - ‡∏ß‡∏ä‡∏¥‡∏£‡∏≤‡∏ß‡∏∏‡∏ò‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .loading { display: none; }
    .loading.show { display: flex; }
    .success-message { background-color: #dcfce7; color: #15803d; }
    .error-message { background-color: #fee2e2; color: #b91c1c; }
    .info-message { background-color: #e0f2fe; color: #0369a1; }
  </style>
</head>
<body class="bg-gray-100 text-sm">
<!-- Main Content -->
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Alert Messages -->
    <div id="alertContainer" class="mb-6"></div>



    <!-- Form -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <form id="accommodationForm" class="space-y-6">
            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠ -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≠
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                        <input type="text" name="requesterName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏ß‡∏î/‡πÅ‡∏ú‡∏ô‡∏Å *</label>
                        <input type="text" name="department" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ù‡πà‡∏≤‡∏¢/‡∏™‡∏≤‡∏¢‡∏á‡∏≤‡∏ô *</label>
                        <input type="text" name="division" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                        <input type="tel" name="phone" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="08X-XXX-XXXX">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏• *</label>
                        <input type="email" name="email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="example@vajiravudh.ac.th">
                    </div>
                </div>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    üè† ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å *</label>
                        <select name="accommodationType" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</option>
                            <option value="‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Ñ‡∏£‡∏π">‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Ñ‡∏£‡∏π</option>
                            <option value="‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏°‡∏´‡∏Å‡∏ô‡∏¥‡πÄ‡∏ß‡∏®">‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏°‡∏´‡∏Å‡∏ô‡∏¥‡πÄ‡∏ß‡∏®</option>
                            <option value="‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏±‡πâ‡∏ô/‡∏ï‡∏∂‡∏Å *</label>
                        <select name="floor" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô/‡∏ï‡∏∂‡∏Å</option>
                            <option value="‡∏ä‡∏±‡πâ‡∏ô 1">‡∏ä‡∏±‡πâ‡∏ô 1</option>
                            <option value="‡∏ä‡∏±‡πâ‡∏ô 2">‡∏ä‡∏±‡πâ‡∏ô 2</option>
                            <option value="‡∏ä‡∏±‡πâ‡∏ô 3">‡∏ä‡∏±‡πâ‡∏ô 3</option>
                            <option value="‡∏ä‡∏±‡πâ‡∏ô 4">‡∏ä‡∏±‡πâ‡∏ô 4</option>
                            <option value="‡∏ï‡∏∂‡∏Å A">‡∏ï‡∏∂‡∏Å A</option>
                            <option value="‡∏ï‡∏∂‡∏Å B">‡∏ï‡∏∂‡∏Å B</option>
                            <option value="‡∏ï‡∏∂‡∏Å C">‡∏ï‡∏∂‡∏Å C</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á *</label>
                        <input type="text" name="roomNumber" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô 101, A-205">
                    </div>
                </div>
                

            </div>

            <!-- ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    üìÖ ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å *</label>
                        <input type="date" name="checkInDate" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å *</label>
                        <input type="date" name="checkOutDate" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div id="durationInfo" class="mt-2 text-sm text-gray-600"></div>
            </div>

            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å
                </h2>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å *</label>
                    <input type="number" id="guestCount" name="guestCount" min="1" max="10" value="1" required 
                           class="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="guestDetails" class="space-y-3">
                    <!-- Guest details will be populated by JavaScript -->
                </div>
            </div>

            <!-- ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• -->
            <div class="border-b pb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    üìù ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å
                </h2>
                <textarea name="reason" required rows="4" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°, ‡∏≠‡∏ö‡∏£‡∏°, ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©"></textarea>
            </div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ -->
            <div class="text-center">
                <button type="submit" id="submitBtn" 
                        class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                    üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å
                </button>
            </div>
        </form>
    </div>
</div>



<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>
</div>

<script>
    // Configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyL1Sc-I5YyypsUmr7c-LKqb0kfyP9il1LncmW6aDOVojDgrdWuoeuZMDJ0d6RxFBh3Sw/exec';
    
    // Web App URL for approval links (same as SCRIPT_URL)
    const WEB_APP_URL = SCRIPT_URL;
    
    // Approvers configuration
    const APPROVERS = {
        first: {
            name: '‡∏ô‡∏≤‡∏¢‡∏ß‡∏á‡∏®‡∏Å‡∏£ ‡∏™‡∏°‡∏±‡∏¢‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏°',
            email: 'wongsakorn.s@vajiravudh.ac.th'
        },
        second: {
            name: '‡∏î‡∏£.‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå ‡∏û‡∏£‡∏û‡∏£‡∏£‡∏ô‡∏∏‡∏Å‡∏π‡∏•',
            email: 'davilcompany@gmail.com'
        }
    };

    // DOM Elements
    const form = document.getElementById('accommodationForm');
    const guestCountInput = document.getElementById('guestCount');
    const guestDetailsDiv = document.getElementById('guestDetails');
    const checkInInput = document.querySelector('input[name="checkInDate"]');
    const checkOutInput = document.querySelector('input[name="checkOutDate"]');
    const durationInfo = document.getElementById('durationInfo');

    const loadingOverlay = document.getElementById('loadingOverlay');
    const alertContainer = document.getElementById('alertContainer');

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    checkInInput.min = today;
    checkOutInput.min = today;

    // Initialize guest details
    function updateGuestDetails() {
        const count = parseInt(guestCountInput.value) || 1;
        guestDetailsDiv.innerHTML = '';

        for (let i = 0; i < count; i++) {
            const guestDiv = document.createElement('div');
            guestDiv.className = 'guest-row';
            guestDiv.innerHTML = `
                <h4 class="font-medium text-gray-800 mb-3">
                    üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${i + 1}
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                        <input type="text" name="guest_${i}_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á *</label>
                        <select name="guest_${i}_relationship" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</option>
                            <option value="‡∏ú‡∏π‡πâ‡∏Ç‡∏≠">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</option>
                            <option value="‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</option>
                            <option value="‡∏ö‡∏∏‡∏ï‡∏£">‡∏ö‡∏∏‡∏ï‡∏£</option>
                            <option value="‡∏ö‡∏¥‡∏î‡∏≤">‡∏ö‡∏¥‡∏î‡∏≤</option>
                            <option value="‡∏°‡∏≤‡∏£‡∏î‡∏≤">‡∏°‡∏≤‡∏£‡∏î‡∏≤</option>
                            <option value="‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á">‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á</option>
                            <option value="‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>
                </div>
            `;
            guestDetailsDiv.appendChild(guestDiv);
        }
    }

    // Calculate duration
    function updateDuration() {
        const checkIn = new Date(checkInInput.value);
        const checkOut = new Date(checkOutInput.value);
        const submitBtn = document.getElementById('submitBtn');
        
        if (checkIn && checkOut && checkOut > checkIn) {
            const diffTime = Math.abs(checkOut - checkIn);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            durationInfo.innerHTML = `<span class="text-blue-600 font-medium">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${diffDays} ‡∏ß‡∏±‡∏ô</span>`;
            
            if (diffDays > 5) {
                durationInfo.innerHTML += `<span class="text-red-600 ml-2">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ</span>`;
                submitBtn.disabled = true;
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitBtn.innerHTML = 'üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ (‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏±‡∏ô)';
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                submitBtn.innerHTML = 'üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å';
            }
        } else {
            durationInfo.innerHTML = '';
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            submitBtn.innerHTML = 'üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å';
        }
    }

    // Show alert message
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `p-4 rounded-lg mb-4 ${type}-message`;
        alertDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="text-xl">&times;</button>
            </div>
        `;
        alertContainer.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Show loading
    function showLoading() {
        loadingOverlay.classList.add('show');
    }

    // Hide loading
    function hideLoading() {
        loadingOverlay.classList.remove('show');
    }

    // Send email notification
    async function sendEmailNotification(requestData, requestId, type) {
        try {
            const emailData = new FormData();
            emailData.append('action', 'sendEmail');
            emailData.append('requestId', requestId);
            emailData.append('emailType', type);
            
            // Add Web App URL for approval links
            emailData.append('webAppUrl', WEB_APP_URL);
            
            // Add request details for email content (encode to prevent character issues)
            emailData.append('requesterName', encodeURIComponent(requestData.requesterName));
            emailData.append('requesterEmail', requestData.email);
            emailData.append('department', encodeURIComponent(requestData.department));
            emailData.append('division', encodeURIComponent(requestData.division));
            emailData.append('phone', requestData.phone);
            emailData.append('accommodationType', encodeURIComponent(requestData.accommodationType));
            emailData.append('floor', encodeURIComponent(requestData.floor));
            emailData.append('roomNumber', requestData.roomNumber);
            emailData.append('checkInDate', requestData.checkInDate);
            emailData.append('checkOutDate', requestData.checkOutDate);
            emailData.append('guestCount', requestData.guestCount);
            emailData.append('guests', encodeURIComponent(requestData.guests));
            emailData.append('reason', encodeURIComponent(requestData.reason));
            
            // Add approver information based on email type (encode Thai names)
            if (type === 'first_approver') {
                emailData.append('approverName', encodeURIComponent(APPROVERS.first.name));
                emailData.append('approverEmail', APPROVERS.first.email);
                emailData.append('nextApproverName', encodeURIComponent(APPROVERS.second.name));
                emailData.append('nextApproverEmail', APPROVERS.second.email);
            } else if (type === 'second_approver') {
                emailData.append('approverName', encodeURIComponent(APPROVERS.second.name));
                emailData.append('approverEmail', APPROVERS.second.email);
            } else if (type === 'rejection' || type === 'final_approval') {
                emailData.append('firstApproverName', encodeURIComponent(APPROVERS.first.name));
                emailData.append('firstApproverEmail', APPROVERS.first.email);
                emailData.append('secondApproverName', encodeURIComponent(APPROVERS.second.name));
                emailData.append('secondApproverEmail', APPROVERS.second.email);
            }
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: emailData
            });
            
            const result = await response.json();
            return result;
        } catch (error) {
            console.error('Failed to send email notification:', error);
            return { status: 'error', message: error.message };
        }
    }



    // Submit form
    async function submitForm(e) {
        e.preventDefault();
        
        // Check if duration exceeds 5 days
        const checkIn = new Date(checkInInput.value);
        const checkOut = new Date(checkOutInput.value);
        if (checkIn && checkOut) {
            const diffTime = Math.abs(checkOut - checkIn);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays > 5) {
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏±‡∏ô', 'error');
                return;
            }
        }
        
        showLoading();
        
        try {
            const formData = new FormData();
            formData.append('action', 'submitRequest');
            
            // Basic form data
            const formElements = form.elements;
            for (let element of formElements) {
                if (element.name && element.value && !element.name.startsWith('guest_')) {
                    formData.append(element.name, element.value);
                }
            }

            // Guest data
            const guestCount = parseInt(guestCountInput.value);
            const guests = [];
            
            for (let i = 0; i < guestCount; i++) {
                const name = document.querySelector(`input[name="guest_${i}_name"]`).value;
                const relationship = document.querySelector(`select[name="guest_${i}_relationship"]`).value;
                
                if (!name || !relationship) {
                    throw new Error(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${i + 1} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                }
                
                guests.push({
                    name: name,
                    relationship: relationship,
                    relationshipType: i === 0 ? relationship : undefined
                });
            }
            
            formData.append('guestCount', guestCount);
            formData.append('guests', JSON.stringify(guests));
            formData.append('version', '3.1');

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (result.status === 'success') {
                // Prepare request data for email
                const requestData = {
                    requesterName: document.querySelector('input[name="requesterName"]').value,
                    email: document.querySelector('input[name="email"]').value,
                    department: document.querySelector('input[name="department"]').value,
                    division: document.querySelector('input[name="division"]').value,
                    phone: document.querySelector('input[name="phone"]').value,
                    accommodationType: document.querySelector('select[name="accommodationType"]').value,
                    floor: document.querySelector('select[name="floor"]').value,
                    roomNumber: document.querySelector('input[name="roomNumber"]').value,
                    checkInDate: document.querySelector('input[name="checkInDate"]').value,
                    checkOutDate: document.querySelector('input[name="checkOutDate"]').value,
                    guestCount: guestCount,
                    guests: JSON.stringify(guests),
                    reason: document.querySelector('textarea[name="reason"]').value
                };
                
                // Send email notification to first approver
                const emailResult = await sendEmailNotification(requestData, result.requestId, 'first_approver');
                
                let emailStatus = '';
                if (emailResult && emailResult.status === 'success') {
                    emailStatus = `üìß ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á: ${APPROVERS.first.name} (${APPROVERS.first.email}) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>`;
                } else {
                    emailStatus = '‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö<br>';
                }
                
                showAlert(`
                    üéâ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>
                    ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠: <strong>${result.requestId}</strong><br>
                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${result.approvalStatus}<br>
                    ${emailStatus}
                    <br>üìã <strong>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong><br>
                    1Ô∏è‚É£ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å: ${APPROVERS.first.name}<br>
                    2Ô∏è‚É£ ‡∏´‡∏≤‡∏Å‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á: ${APPROVERS.second.name}<br>
                    <br>üí° <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                `, 'success');
                
                // Reset form
                form.reset();
                updateGuestDetails();
                durationInfo.innerHTML = '';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // Event listeners
    guestCountInput.addEventListener('change', updateGuestDetails);
    checkInInput.addEventListener('change', () => {
        checkOutInput.min = checkInInput.value;
        updateDuration();
    });
    checkOutInput.addEventListener('change', updateDuration);

    form.addEventListener('submit', submitForm);

    // Initialize
    updateGuestDetails();
</script>
</body>
</html>